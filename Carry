-- Carry Tool (Fixed - Bisa Jalan, Target Hanya Emote)
local Tool = Instance.new("Tool")
Tool.Name = "CarryTool"
Tool.RequiresHandle = false
Tool.CanBeDropped = false
Tool.Parent = game.Players.LocalPlayer.Backpack

local carrying = false
local carriedPlayer = nil
local weld = nil

-- Cari player terdekat
local function getClosestPlayer(character, range)
	local closest = nil
	local shortest = range or 10
	for _, plr in pairs(game.Players:GetPlayers()) do
		if plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr ~= game.Players.LocalPlayer then
			local mag = (plr.Character.HumanoidRootPart.Position - character.HumanoidRootPart.Position).magnitude
			if mag < shortest then
				shortest = mag
				closest = plr
			end
		end
	end
	return closest
end

-- Hilangkan tabrakan
local function noCollide(char1, char2)
	for _, p1 in pairs(char1:GetDescendants()) do
		if p1:IsA("BasePart") then
			for _, p2 in pairs(char2:GetDescendants()) do
				if p2:IsA("BasePart") then
					local noCol = Instance.new("NoCollisionConstraint")
					noCol.Part0 = p1
					noCol.Part1 = p2
					noCol.Parent = p1
				end
			end
		end
	end
end

Tool.Activated:Connect(function()
	local char = Tool.Parent
	local humRoot = char:FindFirstChild("HumanoidRootPart")
	if not humRoot then return end

	if carrying then
		-- Lepas carry
		if weld then
			weld:Destroy()
			weld = nil
		end
		if carriedPlayer and carriedPlayer.Character and carriedPlayer.Character:FindFirstChild("HumanoidRootPart") then
			-- Unanchor biar bisa jalan lagi
			carriedPlayer.Character.HumanoidRootPart.Anchored = false
		end
		carriedPlayer = nil
		carrying = false
	else
		-- Cari target
		local target = getClosestPlayer(char, 10)
		if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
			carriedPlayer = target
			local targetRoot = target.Character.HumanoidRootPart

			-- Tempatkan di depan dada
			targetRoot.CFrame = humRoot.CFrame * CFrame.new(0, 1, -1)

			-- Pasang Weld
			weld = Instance.new("Weld")
			weld.Part0 = humRoot
			weld.Part1 = targetRoot
			weld.C0 = CFrame.new(0, 1, -1)
			weld.Parent = humRoot

			-- Hilangkan tabrakan
			noCollide(char, target.Character)

			-- Anchor RootPart target â†’ dia nggak bisa jalan, tapi anim/emote masih bisa
			targetRoot.Anchored = true

			carrying = true
		end
	end
end)

Tool.Unequipped:Connect(function()
	if weld then
		weld:Destroy()
		weld = nil
	end
	if carriedPlayer and carriedPlayer.Character and carriedPlayer.Character:FindFirstChild("HumanoidRootPart") then
		carriedPlayer.Character.HumanoidRootPart.Anchored = false
	end
	carrying = false
	carriedPlayer = nil
end)
